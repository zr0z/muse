<!DOCTYPE html>

<html>
<head>
  <title>muse.m</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>muse.m</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>muse 0.4,
the stupid command line mp3 player for osx.</p>
<p><em>muse may be freely distributed under the MIT license.</em></p>
<p>Frameworks: <em>Foundation</em>, <em>AVFoundation</em>, <em>ncurses</em></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>#import &lt;Foundation/Foundation.h&gt;
#import &lt;AVFoundation/AVFoundation.h&gt;
#include &lt;curses.h&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Uses arc memory management.</p>
<p>Uses <a href="http://ironwolf.dangerousgames.com/blog/archives/913">The Code Commandments</a> best practices for Objective-C coding.</p>
<h2 id="helpers-declaration">Helpers declaration</h2>
<p>Define the usage description printed when executing the command
with a help option (<code>[-h|--help]</code>).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>#define USAGE @<span class="string">"usage: muse [-h|--help] &lt;music files&gt;"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p><code>output</code> is an helper function to display <code>NSString</code> on <code>stdout</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">void</span> output(NSString* string);</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h2 id="custom-errors">Custom Errors</h2>
<p>Define custom error domain and descriptions as <code>NSString</code> constants.</p>
<p>The error domain is <code>muse</code>; the customs errors are:</p>
<ul>
<li><code>MPErrorInputFile</code> when no file is given in arguments.</li>
<li><code>MPErrorFileType</code> when the file can&#39;t be read.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>NSString *<span class="keyword">const</span> MPErrorDomain = @<span class="string">"muse"</span>;
NSString *<span class="keyword">const</span> MPErrorInputFile = @<span class="string">"no input files.\n"</span>;
NSString *<span class="keyword">const</span> MPErrorFileType = @<span class="string">"muse can't handle this file.\n"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h3 id="category-interface-">Category interface.</h3>
<p>Create a category on NSError for muse with two default class methods
that correspond to the customs errors.</p>
<p>The category adds also an instance method which constructs a description
based on the error domain and the error <code>NSLocalizedDescriptionKey</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>@interface NSError(MusePlayer)
+ (NSError *)museErrorInputFile;
+ (NSError *)museErrorFileType;
- (NSString *)description;
@end</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h3 id="category-implementation-">Category implementation.</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre>@implementation NSError(MusePlayer)</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Return a <code>NSError</code> using a <code>MPErrorInputFile</code> localized description.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>+ (NSError *)museErrorInputFile {
  NSDictionary *info = @{NSLocalizedDescriptionKey: MPErrorInputFile};
  <span class="keyword">return</span> [self errorWithDomain:MPErrorDomain code:<span class="number">1</span> userInfo:info];
}</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Return a <code>NSError</code> using a <code>MPErrorFileType</code> localized description.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>+ (NSError *)museErrorFileType {
  NSDictionary *info = @{NSLocalizedDescriptionKey: MPErrorFileType};
  <span class="keyword">return</span> [self errorWithDomain:MPErrorDomain code:<span class="number">2</span> userInfo:info];
}</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Instance method which constructs a description based on the domain
and the <code>NSLocalizedDescriptionKey</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>- (NSString *)description {
  <span class="keyword">return</span> [NSString stringWithFormat:@<span class="string">"%@: error: %@"</span>, self.domain,
    self.localizedDescription];
}
@end</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <h2 id="museasset-class">MuseAsset class</h2>
<h3 id="class-interface-">Class interface.</h3>
<p>The <code>MuseAsset</code> class uses an instance of the <code>AVURLAsset</code> class
to extract some metadatas and store them as properties of the instance.</p>
<p>The main property is the <code>URL</code> used to create the <code>AVURLAsset</code>.</p>
<p>The metadatas properties are:</p>
<ul>
<li><code>length</code>, duration of the asset in seconds,</li>
<li><code>artist</code>, name of the artist if present in the <code>commonMetadata</code>,</li>
<li><code>album</code>, name of the album if present in the <code>commonMetadata</code>,</li>
<li><code>label</code>, label constructed from the other properties,</li>
<li><code>title</code>, title of the asset if present in the <code>commonMetadata</code>.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>@interface MuseAsset : NSObject
@property (assign, nonatomic) int length;
@property (strong, nonatomic) NSString* artist;
@property (strong, nonatomic) NSString* album;
@property (strong, nonatomic) NSString* title;
@property (strong, nonatomic) NSURL* URL;

+ (instancetype)museAssetWithURL:(NSURL *)URL;
- (NSString*)labelForElapsedTime:(int)time;
@end

@interface MuseAsset()
- (id)initWithURL:(NSURL *)URL;
- (NSString *)metadataForKey:(NSString*)key inArray:(NSArray*)metadata;
@end</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <h3 id="class-implementation-">Class implementation.</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre>@implementation MuseAsset</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Class method that create a new instance using an URL.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>+ (instancetype)museAssetWithURL:(NSURL *)URL {
  <span class="keyword">return</span> [[self alloc] initWithURL:URL];
}</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>The <code>initWithURL</code> method initialize each properties
using the asset instance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>- (id)initWithURL:(NSURL *)URL {
  self = [super init];</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Create the <code>AVURLAsset</code> instance using the <code>URL</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  AVURLAsset* asset = [AVURLAsset URLAssetWithURL:URL options:nil];
  <span class="keyword">if</span>(self &amp;&amp; asset){</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Assign <code>MuseAsset</code> url.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    self.URL = URL;</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Calculate the track <code>length</code> in seconds using the <code>value</code>
and the <code>timescale</code> of the <code>duration</code> metadata.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    self.length = asset.duration.value / asset.duration.timescale;</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>initialize the metadata array using the <code>commonMetadata</code> property
of the asset.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    NSArray* metadata = asset.commonMetadata;</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Extract the other properties from the metadata array
calling the <code>metadataForKey:inArray:</code> method.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    self.title = [self metadataForKey:@<span class="string">"title"</span> inArray:metadata];
    <span class="keyword">if</span>(self.title == nil){
      self.title = [[self.URL lastPathComponent] stringByDeletingPathExtension];
    }
    self.artist = [self metadataForKey:@<span class="string">"artist"</span> inArray:metadata];
    <span class="keyword">if</span>(self.artist == nil){
      self.artist = @<span class="string">"Unknown"</span>;
    }
    self.album = [self metadataForKey:@<span class="string">"albumName"</span> inArray:metadata];
  }
  <span class="keyword">return</span> self;
}
- (NSString*)labelForElapsedTime:(int)elapsedTime {</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Transform the track <code>length</code> (in seconds) in a duration in minutes
and seconds, using a formated string.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  NSString* format = @<span class="string">"%02d:%02d"</span>;
  NSString* durationString = [NSString stringWithFormat:format,
    self.length / <span class="number">60</span>, self.length % <span class="number">60</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Transformed the elapsed time using the same format.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  NSString* elapsedString = [NSString stringWithFormat:format,
    elapsedTime / <span class="number">60</span>, elapsedTime % <span class="number">60</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Compose the label property using the other properties.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  format = @<span class="string">"%@ (%@/%@) - %@"</span>;
  NSString* label = [NSString stringWithFormat: format,
    self.title, elapsedString, durationString, self.artist];
  <span class="keyword">if</span>(self.album != nil){
    label = [label stringByAppendingFormat:@<span class="string">" (%@)"</span>, self.album];
  }
  <span class="keyword">return</span> label;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Parse a <code>NSArray</code> of <code>AVMetadataItem</code> using a <code>NSString</code>
as the common key.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>- (NSString *)metadataForKey:(NSString*)key inArray:(NSArray*)metadata {</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Parse the metadata from the asset.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  NSArray* collected = [AVMetadataItem metadataItemsFromArray:metadata
    withKey:key keySpace: AVMetadataKeySpaceCommon];
  NSString* value;</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Return the corresponding <code>NSString</code> if found.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span>([collected count] &gt; <span class="number">0</span>){
      value = ( (AVMetadataItem*) collected[<span class="number">0</span>] ).stringValue;
  }
  <span class="keyword">return</span> value;
}
@end</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <h2 id="museplayer-class">MusePlayer class</h2>
<h3 id="class-interface-">Class interface.</h3>
<p>The <code>MusePlayer</code> class is responsible for managing the list of assets
and controling the <code>AVAudioPlayer</code> instance.</p>
<p>It implements several methods that are just wrappers around the player
methods.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>@interface MusePlayer : NSObject

@property (strong, nonatomic) MuseAsset *current;
@property (copy, nonatomic) NSArray *assets;

+ (instancetype) playerWithResources:(NSArray*)resources
  error:(NSError **)error;
- (BOOL)isPlaying;
- (<span class="keyword">void</span>)play;
- (<span class="keyword">void</span>)pause;
- (<span class="keyword">void</span>)toggle;
- (<span class="keyword">void</span>)stop;
- (BOOL)previous;
- (BOOL)next;
- (int)currentTrack;
- (int)totalTracks;
@end</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Let&#39;s use a <code>category</code> to obfuscate our private properties
and methods</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>@interface MusePlayer() &lt;AVAudioPlayerDelegate&gt;
  @property (assign, nonatomic) int track;
  @property (assign, nonatomic) BOOL isPaused;
  @property (strong, nonatomic) AVAudioPlayer *player;

- (BOOL)prepareToPlayTrackAt:(int)track;
- (BOOL)playTrackAt:(int)track;
- (id) initWithResources:(NSArray*)resources error:(NSError **)error;
- (<span class="keyword">void</span>)addAssetWithURL:(NSURL*)URL error:(NSError **)error;
- (<span class="keyword">void</span>)audioPlayerDecodeErrorDidOccur:(AVAudioPlayer *)player
    error:(NSError *)error;
- (<span class="keyword">void</span>)audioPlayerDidFinishPlaying:(AVAudioPlayer *)player
    successfully:(BOOL)flag;
@end</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <h3 id="class-implementation-">Class implementation.</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre>@implementation MusePlayer</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Factory class method that create a new instance using an array
of resources.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>+ (instancetype) playerWithResources:(NSArray*)resources
  error:(NSError **)error {
  <span class="keyword">return</span> [[self alloc] initWithResources:resources error:error];
}</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>The <code>initWithResources:error:</code> method create a NSURL for each resources
and add a new asset for each reachable <code>URL</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>- (id) initWithResources:(NSArray*)resources error:(NSError **)error {
  <span class="keyword">if</span>(self = [super init]){
    self.assets = @[];
    <span class="keyword">for</span> (NSString* path <span class="keyword">in</span> resources) {
      NSURL* url = [NSURL fileURLWithPath:path isDirectory:NO];
      <span class="keyword">if</span>([url checkResourceIsReachableAndReturnError:error]){
        [self addAssetWithURL:url error:error];
      }
    }
    <span class="keyword">if</span>([self.assets count] &gt; <span class="number">0</span>){</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>TO_FIX find a better way to log benign errors.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      error = nil;</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Call the <code>prepareToPlayTrackAt:</code> method to set the player
and start the buffering of the asset.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      [self prepareToPlayTrackAt:<span class="number">0</span>];
    }
  }
  <span class="keyword">return</span> self;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Create an asset using its url and a pointer to a <code>NSError</code> instance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>- (<span class="keyword">void</span>)addAssetWithURL:(NSURL*)URL error:(NSError **)error {
  MuseAsset *asset = [MuseAsset museAssetWithURL:URL];</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Return an error if the file has no length.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span>(asset.length == <span class="number">0</span>){
    *error = [NSError museErrorFileType];
  } <span class="keyword">else</span> {
    self.assets = [self.assets arrayByAddingObject: asset];
  }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Create an audio player and prepare it to read the asset.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>- (BOOL)prepareToPlayTrackAt:(int)track {</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>We start with a basic check to avoid range errors.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span>(track &lt; <span class="number">0</span> || track &gt; [self.assets count] - <span class="number">1</span>){
    <span class="keyword">return</span> NO;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Assign the current asset and initialize a few properties.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  self.track = track;
  self.current = self.assets[self.track];
  self.isPaused = NO;</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Stop reading any asset that could be already loaded.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  [self.player stop];</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Remove the reference to the delegate of the player.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  self.player.delegate = nil;</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Instantiate a new player with the current url.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  self.player = [[AVAudioPlayer alloc] initWithContentsOfURL:self.current.URL error:nil];</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Set the delegate of the player to the instance of the MusePlayer.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  self.player.delegate = self;</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Prepare the player to read the asset.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">return</span> [self.player prepareToPlay];
}</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Play the track at the specified index.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>- (BOOL)playTrackAt:(int)track {
  <span class="keyword">if</span>([self prepareToPlayTrackAt:track]){
    [self play];
    <span class="keyword">return</span> YES;
  }
  <span class="keyword">return</span> NO;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Wrapper around the <code>isPlaying</code> method of the player.
We also return true if the music is just paused.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>- (BOOL)isPlaying {
  <span class="keyword">return</span> [self.player isPlaying] || self.isPaused;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Wrapper around the <code>play</code> method of the player.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>- (<span class="keyword">void</span>)play {
  [self.player play];
  self.isPaused = NO;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Wrapper around the <code>pause</code> method of the player.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>- (<span class="keyword">void</span>)pause {
  [self.player pause];
  self.isPaused = YES;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Toggle between <code>play</code> and <code>pause</code> state.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>- (<span class="keyword">void</span>)toggle {
  <span class="keyword">if</span>(self.isPaused){
    [self play];
  } <span class="keyword">else</span> {
    [self pause];
  }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>Wrapper around the <code>stop</code> method of the player.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>- (<span class="keyword">void</span>)stop {
  [self.player stop];
}</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Jump to the previous song.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>- (BOOL)previous {
  <span class="keyword">return</span> [self playTrackAt: self.track - <span class="number">1</span>];
}</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>Jump to the next song.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>- (BOOL)next {
  <span class="keyword">return</span> [self playTrackAt: self.track + <span class="number">1</span>];
}</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>Return the current track.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>- (int)currentTrack {
  <span class="keyword">return</span> self.track;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Return the total number of tracks.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>- (int)totalTracks {
  <span class="keyword">return</span> [self.assets count];
}</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Methods required by the <code>AVAudioPlayerDelegate</code> protocol.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>- (<span class="keyword">void</span>)audioPlayerDecodeErrorDidOccur:(AVAudioPlayer *)player
  error:(NSError *)error {}
- (<span class="keyword">void</span>)audioPlayerDidFinishPlaying:(AVAudioPlayer *)player
  successfully:(BOOL)flag {}
@end</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <h2 id="main-function">Main function</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>int main (int argc, <span class="keyword">const</span> char * argv[]) {
  int returnCode = <span class="number">0</span>;
  @autoreleasepool {</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>Get the arguments from the command line. <strong>muse</strong> accepts
either a help option (<code>[-h|--help]</code>) or a file.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    NSArray* arguments = [[NSProcessInfo processInfo] arguments];
    int length = [arguments count];</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>Test if the help option (<code>[-h|--help]</code>) is present
in the arguments list.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span>([arguments containsObject:@<span class="string">"-h"</span>]
      || [arguments containsObject:@<span class="string">"--help"</span>]){
      output(USAGE);
    } <span class="keyword">else</span> <span class="keyword">if</span>(length == <span class="number">1</span>){</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>Return an error if no arguments were given.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      NSError *error = [NSError museErrorInputFile];
      output(error.description);
      returnCode = error.code;
    } <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>Create a range and derive a new array from the arguments,
excluding the executable name.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      NSRange range;
      range.location = <span class="number">1</span>;
      range.length = length - <span class="number">1</span>;
      NSArray* resources = [arguments subarrayWithRange:range];</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>Initialise the <code>MusePlayer</code> instance with the resources.
TODO: add directory handling.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      NSError* error = nil;
      MusePlayer* muse = [MusePlayer playerWithResources:resources
        error:&amp;error];

      <span class="keyword">if</span>(error != nil){</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p> Exit with an error if the first file is not a media file.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        output(error.description);
        returnCode = error.code;
      } <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>These variables will store the current and elapsed time.
The screen will be redrawn only if the values are not equals.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        int elapsedTime, currentTime;</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p><code>control</code> will hold the character pressed, if any.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        char control;</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>The status variable for the main application loop,
terminate the app if set to <code>NO</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        BOOL isPlaying = YES;</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>Initialise <code>ncurses</code> with the usual functions.
First, initialise the screen.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        initscr();</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>Set a default timeout in order to avoid blocking the reading
loop while calling the <code>getch</code> function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        timeout(<span class="number">100</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>Then specify that we want to get characters as soon as they
are typed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        cbreak();</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>But we don&#39;t want any visual feedback.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        noecho();</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>Start reading the assets.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        [muse play];</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>Let&#39;s start the main application loop.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">while</span>(isPlaying){</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>Listen to the key pressed while the music is playing.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="keyword">while</span>((control = getch()) &amp;&amp; [muse isPlaying]){
            currentTime = [muse.player currentTime];</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>We redraw the screen only every seconds.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span>(elapsedTime != currentTime){
              elapsedTime = currentTime;</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>First we construct the label that will be displayed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              NSString* string = [muse.current labelForElapsedTime:elapsedTime];
              string = [NSString stringWithFormat:@<span class="string">"%d/%d %@"</span>,
                                 [muse currentTrack] + <span class="number">1</span>,
                                 [muse totalTracks],
                                 string];</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>Then we clear the screen.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              erase();</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>And finaly we use a <code>ncurses</code> function to print
the current track informations and the time elapsed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              mvprintw(<span class="number">0</span>, <span class="number">0</span>, <span class="string">"%s"</span>, string.UTF8String);
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>Let&#39;s use <code>wasd</code> to control the player.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span>(control == <span class="string">'w'</span>){</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p><code>w</code> quit the player.
First stop reading the current track.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              [muse stop];</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>Then set <code>isPlaying</code> to <code>NO</code> to exit the application loop.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              isPlaying = NO;</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>And finally exit the current reading loop.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="keyword">break</span>;
            } <span class="keyword">else</span> <span class="keyword">if</span>(control == <span class="string">'a'</span>){</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p><code>a</code> play previous track.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              [muse previous];</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>Set current time to a negative number in order
to force next redraw.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              currentTime = -<span class="number">1</span>;
            } <span class="keyword">else</span> <span class="keyword">if</span>(control == <span class="string">'s'</span>){</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p><code>s</code> toggle pause/play.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              [muse toggle];
            } <span class="keyword">else</span> <span class="keyword">if</span>(control == <span class="string">'d'</span>){</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p><code>d</code> play next track.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              [muse next];</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p>Set current time to a negative number in order
to force next redraw.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              currentTime = -<span class="number">1</span>;
            }
          }</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>If we don&#39;t have any tracks in the queue, we stop the
application loop.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="keyword">if</span>(![muse next]){
            isPlaying = NO;
          }
        }
      }
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>Let&#39;s be gentle and clean the screen before exiting.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  erase();
  endwin();
  <span class="keyword">return</span> returnCode;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <h2 id="helpers-functions">Helpers functions</h2>
<p><code>ouput</code> prints a string to the <code>stdout</code> using the <code>UTF8String</code> property
of the <code>NSString</code> argument.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">void</span> output(NSString* string){
  fprintf(stdout, <span class="string">"\r%-72s"</span>, string.UTF8String);
  fflush(stdout);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>Copyright (c) 2012 Zaidin Amiot.</p>

            </div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
